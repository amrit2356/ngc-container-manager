#!/usr/bin/env bash
# MLEnv - ML Environment Manager (Refactored)
# Version: 2.0.0
# This file contains only command routing - all implementation is in lib/mlenv/

set -euo pipefail

# ============================================================================
# ENVIRONMENT SETUP
# ============================================================================

# Detect installation location
if [[ -f "/usr/local/lib/mlenv/core/engine.sh" ]]; then
    export MLENV_LIB="/usr/local/lib/mlenv"
elif [[ -f "/usr/lib/mlenv/core/engine.sh" ]]; then
    export MLENV_LIB="/usr/lib/mlenv"
else
    # Development mode - use relative path
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    export MLENV_LIB="$(dirname "$SCRIPT_DIR")/lib/mlenv"
fi

# Verify library exists
if [[ ! -d "$MLENV_LIB" ]]; then
    echo "Error: MLEnv library not found at: $MLENV_LIB" >&2
    exit 1
fi

# ============================================================================
# GLOBAL VARIABLES
# ============================================================================

VERSION="2.0.0"
WORKDIR="$(pwd)"
PROJECT_NAME="$(basename "$WORKDIR")"
WORKDIR_HASH="$(echo "$WORKDIR" | md5sum | cut -c1-8)"
CONTAINER_NAME="mlenv-${PROJECT_NAME}-${WORKDIR_HASH}"
LOG_DIR="$WORKDIR/.mlenv"
LOG_FILE="$LOG_DIR/mlenv.log"
REQUIREMENTS_MARKER="$LOG_DIR/.requirements_installed"

# Command-line options (will be populated by option parser)
IMAGE=""
REQUIREMENTS_PATH=""
FORCE_REQUIREMENTS=false
VERBOSE=false
PORTS=""
JUPYTER_PORT=""
GPU_DEVICES=""
ENV_FILE=""
MEMORY_LIMIT=""
CPU_LIMIT=""
RUN_AS_USER=true
EXEC_CMD=""

mkdir -p "$LOG_DIR"

# ============================================================================
# LOAD CORE LIBRARIES
# ============================================================================

# Core engine (logging, config, etc.)
source "${MLENV_LIB}/core/engine.sh"

# Utility functions (only if they exist - some may be in core)
[[ -f "${MLENV_LIB}/utils/port-utils.sh" ]] && source "${MLENV_LIB}/utils/port-utils.sh"
[[ -f "${MLENV_LIB}/utils/container-utils.sh" ]] && source "${MLENV_LIB}/utils/container-utils.sh"

# ============================================================================
# LOAD COMMAND IMPLEMENTATIONS
# ============================================================================

# Load all command modules
if [[ -d "${MLENV_LIB}/commands" ]]; then
    for cmd_file in "${MLENV_LIB}/commands"/*.sh; do
        [[ -f "$cmd_file" ]] && source "$cmd_file"
    done
fi

# ============================================================================
# COMMAND-LINE PARSING
# ============================================================================

# Parse command
command="${1:-help}"
shift || true

# Store remaining arguments for commands
declare -a CMD_ARGS=()

# Parse options
while [[ $# -gt 0 ]]; do
    case "$1" in
        --image)
            IMAGE="$2"
            shift 2
            ;;
        --requirements)
            REQUIREMENTS_PATH="$2"
            shift 2
            ;;
        --force-requirements)
            FORCE_REQUIREMENTS=true
            shift
            ;;
        --port)
            if [[ "$command" == "jupyter" ]]; then
                JUPYTER_PORT="$2"
            else
                PORTS="$2"
            fi
            shift 2
            ;;
        --gpu)
            GPU_DEVICES="$2"
            shift 2
            ;;
        --env-file)
            ENV_FILE="$2"
            shift 2
            ;;
        --memory)
            MEMORY_LIMIT="$2"
            shift 2
            ;;
        --cpus)
            CPU_LIMIT="$2"
            shift 2
            ;;
        --no-user-mapping)
            RUN_AS_USER=false
            shift
            ;;
        --verbose)
            VERBOSE=true
            export MLENV_VERBOSE=true
            shift
            ;;
        -c)
            EXEC_CMD="$2"
            shift 2
            ;;
        --template|-t)
            CMD_ARGS+=("$1" "$2")
            shift 2
            ;;
        --list|-l)
            CMD_ARGS+=("$1")
            shift
            ;;
        *)
            # Save non-option arguments for the command
            CMD_ARGS+=("$1")
            shift
            ;;
    esac
done

# Override config with command-line options
[[ -n "$IMAGE" ]] && export MLENV_DEFAULT_IMAGE="$IMAGE"
[[ -n "$GPU_DEVICES" ]] && export MLENV_GPU_DEVICES="$GPU_DEVICES"
[[ -n "$PORTS" ]] && export MLENV_PORTS="$PORTS"
[[ -n "$ENV_FILE" ]] && export MLENV_ENV_FILE="$ENV_FILE"
[[ -n "$MEMORY_LIMIT" ]] && export MLENV_MEMORY_LIMIT="$MEMORY_LIMIT"
[[ -n "$CPU_LIMIT" ]] && export MLENV_CPU_LIMIT="$CPU_LIMIT"
[[ -n "$RUN_AS_USER" ]] && export MLENV_RUN_AS_USER="$RUN_AS_USER"

# ============================================================================
# ENGINE INITIALIZATION
# ============================================================================

# Initialize engine for commands that need it
case "$command" in
    init|catalog|config|version|--version|-v|help|--help|-h)
        # Skip engine init for these lightweight commands
        ;;
    *)
        # Initialize engine for container/registry operations
        set +e
        engine_init
        set -e
        # Ensure all environment variables are set for set -u compatibility
        export MLENV_ENV_FILE="${MLENV_ENV_FILE:-}"
        export MLENV_MEMORY_LIMIT="${MLENV_MEMORY_LIMIT:-}"
        export MLENV_CPU_LIMIT="${MLENV_CPU_LIMIT:-}"
        ;;
esac

# ============================================================================
# COMMAND ROUTING
# ============================================================================

case "$command" in
    # Project & Configuration
    init)     cmd_init "${CMD_ARGS[@]+"${CMD_ARGS[@]}"}" ;;
    config)   cmd_config "${CMD_ARGS[@]+"${CMD_ARGS[@]}"}" ;;
    
    # NGC Registry
    login)    cmd_login ;;
    logout)   cmd_logout ;;
    catalog)  cmd_catalog "${CMD_ARGS[@]+"${CMD_ARGS[@]}"}" ;;
    
    # Container Lifecycle
    up)       cmd_up ;;
    down)     cmd_down ;;
    restart)  cmd_restart ;;
    rm)       cmd_rm ;;
    
    # Container Interaction
    exec)     cmd_exec ;;
    jupyter)  cmd_jupyter ;;
    
    # Information
    status)   cmd_status ;;
    logs)     cmd_logs ;;
    version|--version|-v)  cmd_version ;;
    help|--help|-h)  cmd_help ;;
    
    # Unknown command
    *)
        die "Unknown command: $command. Use 'mlenv help' for usage."
        ;;
esac
